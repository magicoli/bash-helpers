#!/bin/sh

SOA=glenn.speculoos.net
KEY=/Users/magic/.keys/glenn.speculoos.net.key
# KEY=/Users/magic/.keys/Kmagic.+157+55459.key

[ ! -f $KEY ] && KEY=~/.keys/$SOA.key
[ ! -f $KEY ] && echo "key $KEY not found" && exit 1

DOMAIN=van-helden.net
# HOST=beegie
IP=192.168.1.1

PGM=`basename $0`
TMP=/tmp/$PGM

# HOST=`hostname | cut -d "." -f 1 | tr [:upper:] [:lower:]`

# if [ ! "$HOST" ]
# 	then
# 	exit 1
# fi

# echo "$HOST"

if [ ! "$1" ]
	then
	HOST=`hostname | cut -d "." -f 1 | tr [:upper:] [:lower:]`
else
	echo "$1" | egrep "\..*\." >/dev/null
	if [ $? -eq 0 ]
		then
		## host + domain
		HOST=`echo "$1" | cut -d "." -f 1` \
		DOMAIN=`echo "$1" | cut -d "." -f 2-`
	else
		echo "$1" | egrep -v "\." >/dev/null
		if [ $? -eq 0 ]
			then
			## host only
			HOST=`echo "$1" | cut -d "." -f 1`
		else
			## domain only
			DOMAIN=$1
		fi
	fi
fi

if [ "$2" ]
	then
	if [ "$2" = "external" ]
		then
		BASEDIR=`dirname $0`
		. "$BASEDIR/functions.sh"
		IP=$(get_public)
	else
		echo "$2" | egrep -v "[^0-9]*\.[^0-9]*\.[^0-9]*\.[^0-9]*" || exit 2
		IP=$2
	fi
else
	netcard=`netstat -rn | grep default | head -1 | sed "s/.* //"`
	IP=`ifconfig $netcard | grep "inet " | egrep -v "127.0.0.1|inet 172.16|inet 169.254"| sed "s/^.*inet //"|cut -d " " -f 1 | head -1`
	if [ ! $IP ]
		then
		IP=`ifconfig | grep "inet " | egrep -v "127.0.0.1|inet 172.16|169.254"| sed "s/^.*inet //"|cut -d " " -f 1 | head -1`
	fi
fi

if [ "$HOST" = "@" ]
	then
	fullhost="@"
elif [ "$HOST" ]
	then
	fullhost="$HOST.$DOMAIN"
else
	fullhost="$DOMAIN"
fi

touch "$TMP.$fullhost.ip" 2>/dev/null

oldip=`cat "$TMP.$fullhost.ip" 2>/dev/null | cut -f 1`

if [ "$oldip" = "$IP" ]
	then
	exit
fi


printf "$IP\t`date`" > "${TMP}.${fullhost}.ip"

printf "$PGM:\t$HOST\t$IP ($oldip)\t`date`\n"

#echo "$HOST $DOMAIN $IP"
#exit
echo $SOA

echo "server $SOA
zone $DOMAIN
update delete $fullhost. A
update add $fullhost. 1800 A $IP
show
send
" | nsupdate -k $KEY && printf "$IP\t`date`" > "$TMP.$fullhost.ip"
